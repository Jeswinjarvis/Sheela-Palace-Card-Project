<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Finder â€“ Sheet1 Live Search</title>
  <style>
    :root{
      --bg:#000000; --panel:#0f172a; --line:#1f2a44; --text:#e5e7eb; --muted:#9aa7bf;
      --accent:#38bdf8; --accent2:#6366f1;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(1200px 600px at 10% -10%, #000000 0%, transparent 60%),
        radial-gradient(1000px 500px at 110% 110%, #0f172a 0%, transparent 60%),
        var(--bg);
      color:var(--text);
    }
    header{
      padding:16px 20px; border-bottom:1px solid var(--line);
      background:linear-gradient(180deg, rgba(99,102,241,.15), rgba(56,189,248,.08) 60%, transparent);
      position:sticky; top:0; z-index:5;
    }
    h1{ margin:0; font-size:18px; font-weight:700; letter-spacing:.2px }
    .wrap{ max-width:1200px; margin:20px auto; padding:0 16px; }
    .toolbar{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:12px 0 16px 0;
    }
    .search{
      display:flex; align-items:center; gap:10px; flex:1;
      background:rgba(15,23,42,.7); border:1px solid var(--line); border-radius:14px; padding:10px 12px;
    }
    .search input{
      flex:1; background:transparent; border:0; outline:none; color:var(--text); font-size:15px;
    }
    .count{ color:var(--muted); font-size:13px; }
    .card{
      background:rgba(15,23,42,.7); border:1px solid var(--line); border-radius:16px; padding:10px; box-shadow:0 10px 30px rgba(0,0,0,.25);
      overflow:auto;
    }
    table{ width:100%; border-collapse:collapse; min-width:900px; }
    th, td{ border-bottom:1px solid var(--line); padding:10px 12px; text-align:left; }
    th{ background:rgba(99,102,241,.15); position:sticky; top:0; z-index:2; }
    tr:hover td{ background:rgba(56,189,248,.05); }
    .muted{ color:var(--muted); }
    body::before{
      content:"";
      position: fixed;
      inset: 0;
      background: url('https://sheelapalaceliffeyvalley.com/assets/club/logo-club.png') no-repeat center center;
      background-size: clamp(320px, 45vw, 720px);
      opacity: 0.12;
      pointer-events: none;
      z-index: 9999;
    }
    .download-btn {
      background: var(--accent2);
      color: white;
      border: none;
      padding: 8px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
    }
    .download-btn:hover { background: var(--accent); }
    select { padding: 6px 10px; border-radius: 8px; border:1px solid var(--line); background:var(--panel); color:var(--text); }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
  <header>
    <h1>Finder â€¢ </h1>
  </header>

  <main class="wrap">
    <div class="toolbar">
      <select id="colSelect"></select>
      <div class="search">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M21 21l-3.8-3.8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><circle cx="10.5" cy="10.5" r="6.5" stroke="currentColor" stroke-width="2"/></svg>
        <input id="q" placeholder="Search Details" autofocus />
      </div>
      <div id="count" class="count">Loadingâ€¦</div>
      <button id="allDetails" class="download-btn" type="button">All Details</button>
      <button id="download" class="download-btn" type="button">Download PDF</button>
    </div>

    <section class="card">
      <table id="grid"></table>
    </section>
  </main>

  <script>
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwBLU3_4xZ-oG-pmsD4tIC4yPjwMbKpnwv6tso5I6vs6TnA-q413o2vVBrc0aZIWXs/exec';

    const norm = (v) => String(v ?? '').toLowerCase().trim();
    function clampDDMMYYYY(v){
      if (!v) return '';
      const s = String(v);
      let m = s.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/);
      if (m) return `${String(m[3]).padStart(2,'0')}/${String(m[2]).padStart(2,'0')}/${m[1]}`;
      m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
      if (m) {
        let d = +m[1], mo = +m[2], y = m[3];
        if (mo > 12 && d <= 12) { const t=d; d=mo; mo=t; }
        return `${String(d).padStart(2,'0')}/${String(mo).padStart(2,'0')}/${y}`;
      }
      const dt = new Date(s);
      if (!isNaN(dt)) return `${String(dt.getDate()).padStart(2,'0')}/${String(dt.getMonth()+1).padStart(2,'0')}/${dt.getFullYear()}`;
      return s;
    }
    function isDateHeader(h){ return h.toLowerCase().includes('date') || h.toLowerCase().includes('dob') || h.toLowerCase().includes('expiry'); }

    let HEADERS = [];
    let ROWS = [];
    let FILTERED = [];
    let ORIGINAL_ROWS = [];
    let ORIGINAL_HEADERS = [];

    const colSelect = document.getElementById('colSelect');

    function populateDropdown(){
      colSelect.innerHTML = '<option value="">All Columns</option>';
      HEADERS.forEach((h, i) => {
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = h;
        colSelect.appendChild(opt);
      });
    }

    function matchesQuery(row, q){
      if (!q) return true;
      const qn = norm(q);
      const selCol = colSelect.value;
      if(selCol!==''){
        let cell = row[selCol];
        const head = HEADERS[selCol] || '';
        if (isDateHeader(head)) cell = clampDDMMYYYY(cell);
        return norm(cell).includes(qn);
      }
      for (let i=0;i<row.length;i++){
        let cell = row[i];
        const head = HEADERS[i] || '';
        if (isDateHeader(head)) cell = clampDDMMYYYY(cell);
        if (norm(cell).includes(qn)) return true;
      }
      return false;
    }

    function render(rows){
      const grid = document.getElementById('grid');
      if (!HEADERS.length) { grid.innerHTML = '<tr><td class="muted">No data</td></tr>'; return; }
      const headHtml = ['S.No', ...HEADERS].map(h => `<th>${h}</th>`).join('');
      let bodyHtml = '';
      rows.forEach((row, idx) => {
        const cells = row.map((cell, i) => {
          const head = HEADERS[i] || '';
          const val = isDateHeader(head) ? clampDDMMYYYY(cell) : (cell ?? '');
          return `<td>${val}</td>`;
        }).join('');
        bodyHtml += `<tr><td>${idx+1}</td>${cells}</tr>`;
      });
      grid.innerHTML = `<tr>${headHtml}</tr>${bodyHtml}`;
      document.getElementById('count').textContent = `Showing ${rows.length} of ${ROWS.length}`;
    }

    async function load(){
      try{
        document.getElementById('count').textContent = 'Loadingâ€¦';
        const res = await fetch(APPS_SCRIPT_URL);
        const data = await res.json();
        if (!Array.isArray(data) || !data.length) throw new Error('No data');
        HEADERS = data[0].map(h => String(h).trim());
        ROWS = data.slice(1);
        ORIGINAL_ROWS = [...ROWS];
        ORIGINAL_HEADERS = [...HEADERS];
        FILTERED = ROWS;
        populateDropdown();
        render(FILTERED);
      }catch(e){
        console.error(e);
        document.getElementById('grid').innerHTML = '<tr><td class="muted">Failed to load data</td></tr>';
        document.getElementById('count').textContent = 'â€”';
      }
    }

    let t;
    document.getElementById('q').addEventListener('input', () => {
      clearTimeout(t);
      t = setTimeout(() => {
        const q = document.getElementById('q').value;
        FILTERED = ROWS.filter(r => matchesQuery(r, q));
        render(FILTERED);
      }, 120);
    });

    // Customized PDF download
    document.getElementById('download').addEventListener('click', () => {
      if (!ROWS || !ROWS.length) { alert("No data to export."); return; }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });

      doc.setFontSize(18);
      doc.setTextColor(40,40,40);
      doc.text("Sheela Palace Card Customer Data Report", 40, 40);
      doc.setFontSize(10);
      doc.text(`Generated: ${new Date().toLocaleString()}`, 40, 60);

      const bodyData = FILTERED.map((row, idx) => [idx+1,...row]);

      doc.autoTable({
        startY:80,
        head:[['S.No', ...HEADERS]],
        body:bodyData,
        theme:'grid',
        headStyles:{ fillColor:[56,189,248], textColor:255, fontStyle:'bold' },
        bodyStyles:{ fillColor:[15,23,42], textColor:255 },
        alternateRowStyles:{ fillColor:[20,30,50] },
        margin:{ left:40, right:40 },
        styles:{ fontSize:9, cellPadding:4 },
        didDrawPage: function(data){
          const page = doc.getCurrentPageInfo().pageNumber;
          doc.setFontSize(9); doc.setTextColor(100);
          doc.text(`Page ${page}`, data.settings.margin.left, doc.internal.pageSize.height-10);
          doc.setFontSize(60); doc.setTextColor(200,200,200);
          
        }
      });
      doc.save(`Sheela Palace Card Customer Report ${new Date().toLocaleString()}.pdf`);
    });

    // ðŸ”¥ All Details button â†’ merge Sheet1 + Sheet2, toggle back
    let allDetailsActive = false;
    document.getElementById('allDetails').addEventListener('click', async () => {
      try{
        if(!allDetailsActive){
          document.getElementById('count').textContent = 'Loading all detailsâ€¦';
          const [res1,res2] = await Promise.all([
            fetch(APPS_SCRIPT_URL+'?members=1').then(r=>r.json()),
            fetch(APPS_SCRIPT_URL+'?sheet2=1').then(r=>r.json())
          ]);
          if(!Array.isArray(res1) || !res1.length || !Array.isArray(res2) || !res2.length) throw new Error('No data');

          const head1=res1[0].map(h=>h.toLowerCase());
          const head2=res2[0].map(h=>h.toLowerCase());

          const idx1 = { qrid:head1.indexOf('qr code id'), name:head1.indexOf('name'), card:head1.indexOf('card type') };
          const idx2 = { qrid:head2.findIndex(h=>h.includes('qr')), date:head2.findIndex(h=>h.includes('date')), time:head2.findIndex(h=>h.includes('time')), people:head2.findIndex(h=>h.includes('people')), branch:head2.findIndex(h=>h.includes('branch')) };

          const map1={};
          res1.slice(1).forEach(r=>{ const q=r[idx1.qrid]; if(!q) return; map1[q]={qrid:q, name:r[idx1.name], card:r[idx1.card]}; });

          const merged = res2.slice(1).map(r=>{ const q=r[idx2.qrid]; const m=map1[q]||{}; return [q, m.card||'', m.name||'', r[idx2.date]||'', r[idx2.time]||'', r[idx2.people]||'', r[idx2.branch]||'']; });

          HEADERS=['QR Code ID','Card Type','Name','Date','Time','People','Location of Branch'];
          ROWS=merged; FILTERED=merged; allDetailsActive=true;
          populateDropdown();
          render(FILTERED);
        } else {
          // toggle back
          HEADERS = [...ORIGINAL_HEADERS];
          ROWS = [...ORIGINAL_ROWS];
          FILTERED = ROWS;
          allDetailsActive=false;
          populateDropdown();
          render(FILTERED);
        }
      }catch(e){ console.error(e); document.getElementById('grid').innerHTML='<tr><td class="muted">Failed to load All Details</td></tr>'; document.getElementById('count').textContent='â€”'; }
    });

    window.addEventListener('DOMContentLoaded', load);
  </script>
</body>
</html>
